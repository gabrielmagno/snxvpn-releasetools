#!/usr/bin/python

import sys
import re
import os
from datetime import datetime
from optparse import OptionParser

tag_re   = 'tags/((release|V)_[^_]*_?([0-9]+_[0-9]+))'
trunk_re = 'trunk'

def get_popen (cmd) :
    """ return stripped stdout from external command """
    fd  = os.popen (cmd)
    ret = fd.read ().strip ()
    fd.close ()
    return ret
# end def get_popen

def up_to_date_rev (name, do_notag = True) :
    """convention: A revision is name_X_Y where name is the released
       revision and X and Y are major an minor number
    """
    
    url        = get_popen ("svn info | grep '^URL'")
    rev        = get_popen ("svnversion -c .").rstrip ("S")
    rev        = rev.split (':') [-1]
    suffix     = '$'
    notag      = 'NO_TAG_'
    if not do_notag :
        notag = ''
    if name :
        suffix = '/%s$' % name
    tag_rgx    = re.compile (tag_re   + suffix)
    trunk_rgx  = re.compile (trunk_re + suffix)
    m   = tag_rgx.search (url)
    if m :
        if rev.endswith ("M") :
            return "%s%s:%s" % (notag, m.group (1), rev)
        return "V_%s_%s" % (m.group (3), rev)
    m   = trunk_rgx.search (url)
    if m :
        return "%s%s" % (notag, rev)
    return "NO_TAG"
# end def up_to_date_rev

def commit_date () :
    line = get_popen ("svn info | grep '^Last Changed Date:'")
    d, t = line.split (':', 1) [1].split (' ') [1:3]
    dt = datetime.strptime (' '.join ((d, t)), '%Y-%m-%d %H:%M:%S')
    return dt
# end def commit_date

if __name__ == "__main__" :
    usage  = "%prog [-n --no-notag] [project-name]"
    parser = OptionParser (usage = usage)
    parser.add_option \
        ( "-n", "--no-notag"
        , dest    = "do_notag"
        , help    = '''Don't use "NO_TAG" if not an svn tag'''
        , default = True
        , action  = "store_false"
        )
    parser.add_option \
        ( "-d", "--date"
        , dest    = "date"
        , help    = "Output date of last commit"
        , default = False
        , action  = "store_true"
        )
    parser.add_option \
        ( "-t", "--tex-format"
        , dest    = "tex_format"
        , help    = "Output tag and date of last commit in TeX format"
        , default = False
        , action  = "store_true"
        )
    (options, args) = parser.parse_args ()
    if len (args) > 1 :
        parser.print_help (sys.stderr)
        sys.exit (23)
    project = ''
    if len (args) == 1 :
        project = args [0]
    if options.tex_format :
        r = up_to_date_rev (project, options.do_notag)
        if r.endswith ('M') :
            r = r.replace ('M', ' (modified)')
        print "\\renewcommand{\\revision}{V.%s }" % r
        d = commit_date ()
        print d.strftime ("\\def\\runtuxdate{\\formatdate{%d}{%m}{%Y}}")
    elif options.date :
        print commit_date ().strftime ('%Y-%m-%d')
    else :
        print up_to_date_rev (project, options.do_notag)
