#!/usr/bin/python

import sys
import re
import os

tag_re   = 'tags/(release|V)_[^_]*_?([0-9]+_[0-9]+)/%s$'
trunk_re = 'trunk/%s$'

def get_popen (cmd) :
    """ return stripped stdout from external command """
    fd  = os.popen (cmd)
    ret = fd.read ().strip ()
    fd.close ()
    return ret
# end def get_popen

def up_to_date_rev (name) :
    """convention: A revision is name_X_Y where name is the released
       revision and X and Y are major an minor number
    """
    
    url = get_popen ("svn info | grep '^URL'")
    rev = get_popen ("svnversion .").rstrip ("S")
    rgx = re.compile (tag_re % name)
    m   = rgx.search (url)
    if m and not rev.endswith ("M") :
        return "V_%s (%s)" % (m.group (2), rev)
    rgx = re.compile (trunk_re % name)
    m   = rgx.search (url)
    if m and not rev.endswith ("M") :
        return "NO_TAG (%s)" % rev
    return "NO_TAG"
# end def up_to_date_rev

if __name__ == "__main__" :
    if len (sys.argv) != 2 :
        print >> sys.stderr, "Usage: %s <project-name>" % sys.argv [0]
        sys.exit (1)
    print up_to_date_rev (sys.argv [1])
