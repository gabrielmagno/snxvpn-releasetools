README=README
NOTES=notes
CHANGES=changes
RELEASENOTES=ReleaseNotes.txt
RELEASE:=$(shell echo $(LASTRELEASE) | sed -e 's/^V_//' -e 's/_/./g')
ifeq (,${CDUP})
  CDUP:=$(shell svn info | grep '^URL:' | sed -e 's/trunk.*$$//' \
        -e 's/branches.*$$//' -e 's/tags.*$$//' -e 's+.*svn/own/projects/++' \
	-e 's+[^/]*++g' -e 's+/+/..+g' -e 's/^/../')
endif
CSS:=$(CDUP)/content/html/stylesheets/default.css
FRS=frs.sourceforge.net
MKCHLOG=${CDUP}/projects/make/mkchlog.py
VERSIONSED=sed -e 's/_/./g' -e 's/V\.//'

README.html: $(README) $(CSS)
	rst2html --stylesheet=$(CSS) $< > $@

$(NOTES): $(README)
	$(MKCHLOG) $(NOTES) < README > $@

$(CHANGES): $(README)
	$(MKCHLOG) $(CHANGES) < README > $@

$(RELEASENOTES): $(NOTES) $(CHANGES)
	echo Release Name: $(RELEASE)  >> $@
	echo ""                        >> $@
	echo Notes:                    >> $@
	cat $(NOTES)                   >> $@
	echo ""                        >> $@
	echo Changes:                  >> $@
	cat $(CHANGES)                 >> $@

upload_homepage: all
	scp README.html $(USERNAME)@$(HOSTNAME):$(PROJECT_DOCDIR)/index.html
	touch upload_homepage

announce_pypi: all
	python setup.py register
	touch announce_pypi

upload: all $(RELEASENOTES) dist
	@echo Preparing Release $(RELEASE)
	ssh $(USERNAME),$(PROJECT)@shell.sourceforge.net create
	ssh $(USERNAME),$(PROJECT)@shell.sourceforge.net \
	    mkdir $(PROJECT_RELEASEDIR)/$(RELEASE)
	ssh $(USERNAME),$(PROJECT)@shell.sourceforge.net shutdown
	scp dist/* $(RELEASENOTES) \
            $(USERNAME),$(PROJECT)@$(FRS):$(PROJECT_RELEASEDIR)/$(RELEASE)
	touch upload

FOCUS:=$(shell $(MKCHLOG) sf-release-focus < README)
URL:=$(shell python setup.py --url)
LICENSE:=$(shell python setup.py --license | sed 's/Library or //')
FRESHMEAT=freshmeat-submit
#FRESHMEAT=cat

announce: all $(CHANGES) $(NOTES) dist
	 ( echo "Project: $(PROJECT)"    \
	 ; echo "Version: $(RELEASE)" \
	 ; echo "Release-Focus: $(FOCUS)" \
	 ; if [ -n "$(URL)"     ] ; then echo "Home-Page-URL: $(URL)" ; fi \
	 ; if [ -n "$(LICENSE)" ] ; then echo "License: $(LICENSE)"   ; fi \
	 ; echo ""                       \
	 ; cat $(NOTES)                  \
	 ) | $(FRESHMEAT)
	 touch announce

license:
	@echo "$(LICENSE)"

version:
	@echo "$(RELEASE)"

$(VERSIONPY): $(SRC)
	echo 'VERSION="$(LASTRELEASE)"' | $(VERSIONSED) > $@

$(VERSIONH): $(SRC)
	echo '#define VERSION "$(LASTRELEASE)"' | $(VERSIONSED) > $@
